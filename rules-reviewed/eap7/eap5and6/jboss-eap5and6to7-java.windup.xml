<?xml version="1.0"?>
<ruleset id="jboss-eap5and6to7-java"
         xmlns="http://windup.jboss.org/schema/jboss-ruleset"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://windup.jboss.org/schema/jboss-ruleset http://windup.jboss.org/schema/jboss-ruleset/windup-jboss-ruleset.xsd">

    <metadata>
        <description>
            This ruleset provides analysis of both JBoss EAP 5 and JBoss EAP 6 files
            that might require individual attention when migrating to JBoss EAP 7+.
            The purpose of this ruleset is to avoid duplication of rules
            in rulesets dedicated to either version.
        </description>
        <dependencies>
            <addon id="org.jboss.windup.rules,windup-rules-javaee,2.6.0.Final"/>
            <addon id="org.jboss.windup.rules,windup-rules-java,2.6.0.Final"/>
        </dependencies>
        <sourceTechnology id="eap" versionRange="[5,7)"/>
        <targetTechnology id="eap" versionRange="[7,)"/>
        <tag>jboss-eap5</tag>
        <tag>jboss-eap6</tag>
    </metadata>

    <rules>
        <rule id="jboss-eap5and6to7-java-01000">
            <when>
                <filecontent filename="MANIFEST.MF" pattern="Dependencies:" />
            </when>
            <perform>
                <iteration>
                    <classification issue-display-mode="all" title="Dependency entries in MANIFEST.MF" effort="1" category-id="mandatory">
                        <description> This appliction contains modules that have dependency entries in their `MANIFEST.MF`
     files.
     
                                        Recommendation: 
                                        
                                        Verify in advance that all the modules that this application depends on still exist.</description>
                        <link title="EAP 7 Implicit Module Dependencies" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.0/html/development_guide/class_loading_and_modules#implicit_module_dependencies"/>
                        <link title="EAP 7 Included Modules" href="https://access.redhat.com/articles/2158031"/>
                        <tag>configuration</tag>
                    </classification>
                </iteration>
            </perform>
        </rule>
         <rule id="jboss-eap5and6to7-java-02000">
            <when>
                <file filename="jbossws-cxf.xml"/>
            </when>
            <perform>
                <iteration>
                    <classification issue-display-mode="all" title="Apache CXF integration with JBoss " effort="3" category-id="mandatory">
                        <description>
                            This application contains Apache CXF XML descriptors. 
                            
                            Recommendation:
                            
                            Migrate all functionality specified in such XML descriptors. These descriptors are generally already supported by the JAX-WS specification, included in Java EE 7. For specific functionality, see the following Red Hat documentation:</description>
                        <link title="Apache CXF Spring Web Services Changes" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.0/single/migration_guide/#migrate_apache_cxf_spring_web_services_changes" />
                        <tag>webservices</tag>
                        <tag>jbossws</tag>
                        <tag>cxf</tag>
                        <tag>configuration</tag>
                    </classification>
                </iteration>
            </perform>
        </rule>
        <rule id="jboss-eap5and6to7-java-03000">
            <when>
                <javaclass references="javax.ejb.EntityBean">
                    <location>IMPLEMENTS_TYPE</location>
                    <location>INHERITANCE</location>
                </javaclass>
            </when>
            <perform>
                <iteration>
                    <hint title="Entity EJB" effort="5" category-id="mandatory">
                        <message>This application contains entity beans, which are no longer supported in JBoss EAP 7.
                            
                                Recommendation:
                                
                                Migrate the entity beans by using JPA's `persistence.xml` or by using JPA annotations.</message>
                        <link title="Migrate Entity Beans to JPA" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.0/single/migration_guide/#migrate_entity_beans_to_jpa" />
                        <tag>cmp</tag>
                        <tag>jpa</tag>
                    </hint>
                </iteration>
            </perform>
        </rule>
        <rule id="jboss-eap5and6to7-java-04000">
            <when>
               <or>
                 <javaclass references="org.apache.catalina.Valve">
                    <location>IMPLEMENTS_TYPE</location>
                </javaclass>
                <javaclass references="org.apache.catalina.valves.ValveBase">
                    <location>INHERITANCE</location>
                </javaclass>
               </or>
            </when>
            <perform>
                <iteration>
                    <classification issue-display-mode="all" title="JBoss Web Valve" effort="3" category-id="mandatory">
                      <description> This application contains JBoss Web valves.
                          
                                    Recommendation:
                          
                                    Migrate JBoss Web valves to Undertow handlers, as described in the following Red Hat documentation:</description>
                      <link title="Migrate JBoss Web Valves" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.0/single/migration_guide/#migrate_jboss_web_valves" />
                      <tag>web</tag>
                      <tag>undertow</tag>
                    </classification>
                </iteration>
            </perform>
        </rule>
        <rule id="jboss-eap5and6to7-java-05000">
            <when>
               <or>
                 <javaclass references="javax.enterprise.deploy{*}">
                    <location>IMPORT</location>
                </javaclass>
               </or>
            </when>
            <perform>
                <iteration>
                    <hint title="JSR 88 deployment plan not supported" effort="1" category-id="mandatory">
                      <message> This application uses JSR-88 classes to automate deployments. 
                          
                                Recommendation:
                          
                                Autate deployment by using the functionality described in the following Red Hat documentation:</message>
                      <link title="Migrate Deployment Plan Configurations" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.0/single/migration_guide/#migrate_deployment_plan_configurations"/>
                      <tag>configuration</tag>
                      <tag>undertow</tag>
                    </hint>
                </iteration>
            </perform>
        </rule>
        <rule id="jboss-eap5and6to7-java-06000">
            <when>
                 <javaclass references="org.jboss.as.clustering.singleton.SingletonService">
                     <location>IMPORT</location>
                 </javaclass>
            </when>
            <perform>
                <iteration>
                    <hint title="Outdated HA Singleton" effort="1" category-id="mandatory">
                      <message>This application contains an older API for building Singleton services.
                          
                                Recommendation:
                                
                                Migrate to EAP 7's API for building Singleton services.</message>
                      <link title="Migration of HA Singleton" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.0/single/migration_guide/#migrate_clustering_ha_singleton"/>
                      <tag>singleton</tag>
                    </hint>
                </iteration>
            </perform>
        </rule>
        <rule id="jboss-eap5and6to7-java-07000">
            <when>
                <javaclass references="org.jboss.ejb3.annotation.Clustered">
                    <location>ANNOTATION</location>
                    <location>IMPORT</location>
                </javaclass>
            </when>
            <perform>
                <hint title="Stateful Session EJB Clustering changes in EAP 7" effort="1" category-id="optional">
                    <message>This application contains the `@Clustered` annotation, which is ignored in EAP 7.
                        
                              Recommendation:
                        
                              Migrate to EAP's clustering behavior according to the reference that follows. Note that if the application is started using an HA profile, replication is done automatically.
                    </message>
                    <link href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.0/single/migration_guide/#migrate_stateful_session_ejb_clustering_changes" title="Stateful Session EJB Clustering Changes" />
                    <tag>cluster</tag>
                    <tag>ejb</tag>
                    <quickfix name="Clustered" type="DELETE_LINE">
                        <search>@Clustered</search>
                    </quickfix>
                    <quickfix name="ClusteredImport" type="DELETE_LINE">
                        <search>org.jboss.ejb3.annotation.Clustered</search>
                    </quickfix>
                </hint>
            </perform>
        </rule>
        <rule id="jboss-eap5and6to7-java-08000">
            <when>
                    <javaclass references="org.hornetq.{*}" />
            </when>
            <perform>
                <classification issue-display-mode="all" title="HornetQ was removed in EAP 7" effort="1" category-id="mandatory">
                    <description>This application contains references to `org.hornetq.*` 
                        
                        Recommendation:
                        
                         Replace all references to `org.hornetq.*` with either the JMS API or with the ActiveMQ Artemis API.</description>
                    <link title="What's new in JBoss EAP 7" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.0/single/migration_guide/#whats_new_in_eap"></link>
                    <link href="https://activemq.apache.org/artemis/migration.html" title="ActiveMQ Artemis Migration" />
                    <tag>hornetq</tag>
                    <tag>jms</tag>
                </classification>
            </perform>
        </rule>
        <rule id="jboss-eap5and6to7-java-09000">
            <when>
                <javaclass references="org.jboss.logging.{annotation}">
                    <location>ANNOTATION</location>
                </javaclass>
            </when>
            <perform>
                <hint title="JBoss deprecated logging annotations" effort="1" category-id="mandatory">
                    <message>This application contains JBoss Logging annotations in the package `org.jboss.logging`, all of which are deprecated. 
                        
                            Recommendation:
                        
                            Replace the JBoss Logging annotations in `org.jboss.logging` by the corresponding annotations in the package `org.jboss.logging.annotations`. Note that using the `org.jboss.logging.annotations` package requires adding a new dependency: `org.jboss.logging:jboss-logging-annotations`.</message>
                    <link href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.0/single/migration_guide/#migrate_jboss_logging_changes" title="JBoss Logging Changes" />
                    <tag>logging</tag>
                </hint>
            </perform>
            <where param="annotation">
                <matches pattern="(Cause|Field|FormatWith|LoggingClass|LogMessage|Message|MessageBundle|MessageLogger|Param|Property)" />
            </where>
        </rule>
    </rules>
</ruleset>
